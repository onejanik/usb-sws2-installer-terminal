name: Build Executables with Nuitka
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest', 'ubuntu-latest', 'macos-latest']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Nuitka Build mit Performance-Optimierungen
    - name: Build with Nuitka (Windows)
      if: matrix.os == 'windows-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: standalone
        output-dir: build
        output-file: SubwaySim2_USB_Installer_Terminal.exe
        windows-console-mode: force
        windows-icon-from-ico: favicon.ico
        company-name: "FärberIT Solutions"
        product-name: "SubwaySim2 USB Installer"
        file-version: "1.0.0.0"
        product-version: "1.0.0"
        file-description: "U-Bahn Berlin Mod Installer"
        copyright: "© 2025 FärberIT Solutions"
        assume-yes-for-downloads: true
        # Performance-Optimierungen
        lto: no  # Deaktiviert Link-Time-Optimization (schneller)
        jobs: 2  # Parallel kompilieren
    
    - name: Build with Nuitka (Linux)
      if: matrix.os == 'ubuntu-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: standalone
        output-dir: build
        output-file: SubwaySim2_USB_Installer_Terminal.bin
        assume-yes-for-downloads: true
        lto: no
        jobs: 2
    
    - name: Build with Nuitka (macOS)
      if: matrix.os == 'macos-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: standalone
        output-dir: build
        output-file: SubwaySim2_USB_Installer_Terminal.bin
        assume-yes-for-downloads: true
        lto: no
        jobs: 2
    
    # Windows Code Signing (ohne Verifikation)
    - name: Sign Windows executable
      if: matrix.os == 'windows-latest'
      env:
        CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
      run: |
        # Dekodiere Zertifikat
        $certBytes = [Convert]::FromBase64String($env:CERTIFICATE_BASE64)
        $certPath = "signing-cert.pfx"
        [IO.File]::WriteAllBytes($certPath, $certBytes)
        
        # Finde signtool.exe
        $signtoolPath = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\*\bin\*\x64\signtool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if (-not $signtoolPath) {
          Write-Error "signtool.exe nicht gefunden!"
          exit 1
        }
        
        # Finde die EXE
        $exePath = Get-ChildItem -Path "build/main.dist" -Filter "*.exe" -Recurse | Select-Object -First 1
        
        if (-not $exePath) {
          Write-Error "Keine EXE gefunden!"
          exit 1
        }
        
        Write-Host "Signiere: $($exePath.FullName)"
        
        # Signiere mit Timestamp
        & $signtoolPath.FullName sign `
          /f $certPath `
          /p $env:CERTIFICATE_PASSWORD `
          /tr http://timestamp.digicert.com `
          /td SHA256 `
          /fd SHA256 `
          /d "SubwaySim2 USB Installer" `
          /du "https://github.com/${{ github.repository }}" `
          $exePath.FullName
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Signierung fehlgeschlagen!"
          exit 1
        }
        
        Write-Host "✓ Signierung erfolgreich"
        Write-Host ""
        Write-Host "Hinweis: Das Zertifikat ist selbst-signiert und wird auf anderen"
        Write-Host "Systemen als 'nicht vertrauenswürdig' angezeigt, bis Nutzer es"
        Write-Host "manuell als vertrauenswürdig markieren."
        
        # Cleanup
        Remove-Item $certPath -Force
      shell: pwsh
    
    # Linux: Executable-Bit setzen
    - name: Prepare Linux executable
      if: matrix.os == 'ubuntu-latest'
      run: |
        find build/main.dist -type f -name "*.bin" -exec chmod +x {} \;
        ls -lh build/main.dist/
    
    # macOS: Executable-Bit setzen
    - name: Prepare macOS executable
      if: matrix.os == 'macos-latest'
      run: |
        find build/main.dist -type f -name "*.bin" -exec chmod +x {} \;
        ls -lh build/main.dist/
    
    # Artifacts hochladen
    - name: Upload Windows artifacts
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: build/main.dist/
        retention-days: 90
    
    - name: Upload Linux artifacts
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: linux-executable
        path: build/main.dist/
        retention-days: 90
    
    - name: Upload macOS artifacts
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: macos-executable
        path: build/main.dist/
        retention-days: 90
    
    # Optional: ZIP für Release erstellen
    - name: Create ZIP archive (Windows)
      if: matrix.os == 'windows-latest' && startsWith(github.ref, 'refs/tags/v')
      run: |
        Compress-Archive -Path "build/main.dist/*" -DestinationPath "SubwaySim2_USB_Installer_Windows.zip"
      shell: pwsh
    
    - name: Create ZIP archive (Linux)
      if: matrix.os == 'ubuntu-latest' && startsWith(github.ref, 'refs/tags/v')
      run: |
        cd build/main.dist
        zip -r ../../SubwaySim2_USB_Installer_Linux.zip .
        cd ../..
    
    - name: Create ZIP archive (macOS)
      if: matrix.os == 'macos-latest' && startsWith(github.ref, 'refs/tags/v')
      run: |
        cd build/main.dist
        zip -r ../../SubwaySim2_USB_Installer_macOS.zip .
        cd ../..
    
    # Release erstellen
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: "*.zip"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
