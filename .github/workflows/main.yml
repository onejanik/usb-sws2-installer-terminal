name: Build Executables with Nuitka
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest', 'ubuntu-latest', 'macos-latest']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    
    - name: Build with Nuitka
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        onefile: true
        standalone: true
        output-file: SubwaySim2_USB_Installer_Terminal
        enable-console: true
        windows-icon-from-ico: favicon.ico
        company-name: "FärberIT Solutions"
        product-name: "SubwaySim2 USB Installer"
        file-version: "1.0.0.0"
        product-version: "1.0.0"
        file-description: "U-Bahn Berlin Mod Installer"
        copyright: "© 2025 FärberIT Solutions"
    
    
    - name: Sign Windows executable
      if: matrix.os == 'windows-latest'
      env:
        CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
      run: |
        
        $certBytes = [Convert]::FromBase64String($env:CERTIFICATE_BASE64)
        $certPath = "signing-cert.pfx"
        [IO.File]::WriteAllBytes($certPath, $certBytes)
        
        
        $signtoolPath = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\*\bin\*\x64\signtool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if (-not $signtoolPath) {
          Write-Error "signtool.exe nicht gefunden!"
          exit 1
        }
        
        Write-Host "Signiere Executable..."
        
        # Signiere mit Timestamp (wichtig für Gültigkeit!)
        & $signtoolPath.FullName sign `
          /f $certPath `
          /p $env:CERTIFICATE_PASSWORD `
          /tr http://timestamp.digicert.com `
          /td SHA256 `
          /fd SHA256 `
          /d "SubwaySim2 USB Installer" `
          /du "https://github.com/${{ github.repository }}" `
          "build\SubwaySim2_USB_Installer_Terminal.exe"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Signierung fehlgeschlagen!"
          exit 1
        }
        
        Write-Host "✓ Signierung erfolgreich"
        
        
        & $signtoolPath.FullName verify /pa /v "build\SubwaySim2_USB_Installer_Terminal.exe"
        
        # Cleanup
        Remove-Item $certPath -Force
      shell: pwsh
    
    
    - name: Prepare Linux executable
      if: matrix.os == 'ubuntu-latest'
      run: |
        chmod +x build/SubwaySim2_USB_Installer_Terminal.bin
        ls -lh build/
    
    
    - name: Prepare macOS executable
      if: matrix.os == 'macos-latest'
      run: |
        chmod +x build/SubwaySim2_USB_Installer_Terminal.bin
        ls -lh build/
    
   
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os }}-executable
        path: build/*
        retention-days: 90
