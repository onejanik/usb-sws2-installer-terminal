name: Build Executables with Nuitka
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest', 'ubuntu-latest', 'macos-latest']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # Nuitka Build - ONEFILE MODE
    - name: Build with Nuitka (Windows - Onefile)
      if: matrix.os == 'windows-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: app  # ← Onefile Mode!
        output-dir: build
        output-file: SubwaySim2_USB_Installer_Terminal.exe
        windows-console-mode: force
        windows-icon-from-ico: favicon.ico
        company-name: "FärberIT Solutions"
        product-name: "SubwaySim2 USB Installer"
        file-version: "1.0.0.0"
        product-version: "1.0.0"
        file-description: "U-Bahn Berlin Mod Installer"
        copyright: "© 2025 FärberIT Solutions"
        assume-yes-for-downloads: true
        # Onefile-Optimierungen
        onefile-tempdir-spec: "{CACHE_DIR}/{COMPANY}/{PRODUCT}/{VERSION}"
    
    - name: Build with Nuitka (Linux - Onefile)
      if: matrix.os == 'ubuntu-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: app
        output-dir: build
        output-file: SubwaySim2_USB_Installer_Terminal.bin
        assume-yes-for-downloads: true
    
    - name: Build with Nuitka (macOS - Onefile)
      if: matrix.os == 'macos-latest'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: main.py
        mode: app
        output-dir: build
        output-file: SubwaySim2_USB_Installer_Terminal.bin
        assume-yes-for-downloads: true
    
    # Windows Code Signing
    - name: Sign Windows executable
      if: matrix.os == 'windows-latest'
      env:
        CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        CERTIFICATE_PASSWORD: ${{ secrets.CERTIFICATE_PASSWORD }}
      run: |
        $certBytes = [Convert]::FromBase64String($env:CERTIFICATE_BASE64)
        $certPath = "signing-cert.pfx"
        [IO.File]::WriteAllBytes($certPath, $certBytes)
        
        $signtoolPath = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\*\bin\*\x64\signtool.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        
        if (-not $signtoolPath) {
          Write-Error "signtool.exe nicht gefunden!"
          exit 1
        }
        
        # Im onefile-Mode ist die EXE direkt im build-Ordner
        $exePath = Get-ChildItem -Path "build" -Filter "*.exe" | Select-Object -First 1
        
        if (-not $exePath) {
          Write-Error "Keine EXE gefunden!"
          Get-ChildItem -Path "build" -Recurse
          exit 1
        }
        
        Write-Host "Signiere: $($exePath.FullName)"
        
        & $signtoolPath.FullName sign `
          /f $certPath `
          /p $env:CERTIFICATE_PASSWORD `
          /tr http://timestamp.digicert.com `
          /td SHA256 `
          /fd SHA256 `
          /d "SubwaySim2 USB Installer" `
          /du "https://github.com/${{ github.repository }}" `
          $exePath.FullName
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Signierung fehlgeschlagen!"
          exit 1
        }
        
        Write-Host "✓ Executable signiert!"
        Remove-Item $certPath -Force
      shell: pwsh
    
    # Executable-Bit setzen (Linux/macOS)
    - name: Prepare Linux executable
      if: matrix.os == 'ubuntu-latest'
      run: |
        chmod +x build/*.bin
        ls -lh build/
    
    - name: Prepare macOS executable
      if: matrix.os == 'macos-latest'
      run: |
        chmod +x build/*.bin
        ls -lh build/
    
    # Artifacts hochladen - nur die einzelne Datei!
    - name: Upload Windows executable
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: SubwaySim2_USB_Installer_Windows
        path: build/*.exe
        retention-days: 90
    
    - name: Upload Linux executable
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: SubwaySim2_USB_Installer_Linux
        path: build/*.bin
        retention-days: 90
    
    - name: Upload macOS executable
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: SubwaySim2_USB_Installer_macOS
        path: build/*.bin
        retention-days: 90
    
    # Release erstellen (bei git tags)
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/*
        draft: false
        prerelease: false
        body: |
          ## Download
          
          **Windows:** `SubwaySim2_USB_Installer_Terminal.exe`
          **Linux:** `SubwaySim2_USB_Installer_Terminal.bin`
          **macOS:** `SubwaySim2_USB_Installer_Terminal.bin`
          
          ### Installation
          
          #### Windows
          1. Datei herunterladen
          2. Doppelklick zum Starten
          3. Falls Windows SmartScreen warnt: "Weitere Informationen" → "Trotzdem ausführen"
          
          #### Linux
          ```
          chmod +x SubwaySim2_USB_Installer_Terminal.bin
          ./SubwaySim2_USB_Installer_Terminal.bin
          ```
          
          #### macOS
          ```
          chmod +x SubwaySim2_USB_Installer_Terminal.bin
          ./SubwaySim2_USB_Installer_Terminal.bin
          ```
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
